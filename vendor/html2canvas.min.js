(function () {
  function collectCssText(doc) {
    var cssText = '';
    Array.prototype.forEach.call(doc.styleSheets, function (sheet) {
      try {
        var rules = sheet.cssRules;
        if (!rules) return;
        Array.prototype.forEach.call(rules, function (rule) {
          cssText += rule.cssText + '\n';
        });
      } catch (err) {
        // Ignore cross-origin stylesheets.
      }
    });
    return cssText;
  }

  function buildSvg(element, width, height) {
    var doc = element.ownerDocument;
    var cssText = collectCssText(doc);
    var clone = element.cloneNode(true);
    var wrapper = doc.createElement('div');
    wrapper.appendChild(clone);
    var serialized = new XMLSerializer().serializeToString(wrapper);
    return (
      '<svg xmlns="http://www.w3.org/2000/svg" width="' +
      width +
      '" height="' +
      height +
      '">' +
      '<foreignObject width="100%" height="100%">' +
      '<style>' +
      cssText +
      '</style>' +
      serialized +
      '</foreignObject></svg>'
    );
  }

  function html2canvas(element, options) {
    options = options || {};
    var rect = element.getBoundingClientRect();
    var width = options.width || rect.width;
    var height = options.height || rect.height;
    var scale = options.scale || 1;
    return new Promise(function (resolve, reject) {
      try {
        var svg = buildSvg(element, width, height);
        var img = new Image();
        img.onload = function () {
          var canvas = document.createElement('canvas');
          canvas.width = width * scale;
          canvas.height = height * scale;
          var ctx = canvas.getContext('2d');
          ctx.scale(scale, scale);
          ctx.drawImage(img, 0, 0);
          resolve(canvas);
        };
        img.onerror = reject;
        img.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      } catch (error) {
        reject(error);
      }
    });
  }

  window.html2canvas = html2canvas;
})();
