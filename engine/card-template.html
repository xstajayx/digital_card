<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Pacifico&family=Quicksand:wght@400;600;700&family=Poppins:wght@400;600;700&family=Nunito:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./card-base.css" />
  <link id="themeStyles" rel="stylesheet" href="" />
  <title>Card Preview</title>
</head>
<body>
  <div class="card-root" id="cardRoot" data-capture-scope="card" data-mode="share">
    <div class="balloon-curtain" id="balloonCurtain" data-reveal="balloons"><div class="dissolve-layer" id="dissolveLayer"></div></div>
    <div class="card">
      <div class="panel top">
        <div class="headline" id="headline">Happy Day</div>
        <div class="message" id="message"></div>
        <div class="from" id="from"></div>
      </div>
      <div class="frame-decor frame-decor-overlay" id="frameDecorOverlay"></div>
      <div class="panel bottom">
        <div class="photo-wrap" id="photoWrap">
          <div class="photo-slot" id="photoSlot"><img id="photo" alt="Uploaded" style="display:none;" /><div class="placeholder" id="placeholder"><span>Upload a photo</span></div></div>
          <div class="frame-decor frame-decor-photo" id="frameDecorPhoto"></div>
        </div>
        <div class="decor-panel" id="decorPanel"><div class="frame-decor" id="frameDecor"></div></div>
        <a id="giftButton" class="gift-button" target="_blank" rel="noopener noreferrer" style="display:none;">View Gift</a>
        <div id="giftDomain" class="gift-domain" style="display:none;"></div>
      </div>
    </div>
    <div class="confetti" id="confetti"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
    <div class="sparkles" id="sparkles"><span></span><span></span><span></span><span></span></div>
    <div class="watermark" id="watermark">Made with JWorldCreations</div>
  </div>
  <script>
    const ITEM_TYPES = ['balloons', 'hearts', 'stars', 'snow', 'confetti'];
    const FONT_MAP = {
      fredoka: '"Fredoka", system-ui, sans-serif',
      pacifico: '"Pacifico", system-ui, sans-serif',
      quicksand: '"Quicksand", system-ui, sans-serif',
      poppins: '"Poppins", system-ui, sans-serif',
      nunito: '"Nunito", system-ui, sans-serif',
      playfair: '"Playfair Display", ui-serif, serif'
    };
    const setVar = (k, v) => document.documentElement.style.setProperty(k, v);
    const normalizeType = (type) => ITEM_TYPES.includes(type) ? type : 'balloons';

    function applyFont(fontId) {
      setVar('--card-font', FONT_MAP[fontId] || FONT_MAP.fredoka);
    }

    function wrapAndClampMessage(text, cols = 19, rows = 12) {
      const words = String(text || '').replace(/\r\n/g, '\n').split(/\s+/).filter(Boolean);
      const lines = [];
      let current = '';

      function pushLine(line) {
        if (lines.length < rows) lines.push(line);
      }

      for (const word of words) {
        if (lines.length >= rows) break;

        if (word.length > cols) {
          if (current) {
            pushLine(current);
            current = '';
            if (lines.length >= rows) break;
          }
          for (let i = 0; i < word.length && lines.length < rows; i += cols) {
            pushLine(word.slice(i, i + cols));
          }
          continue;
        }

        if (!current) {
          current = word;
        } else if ((current.length + 1 + word.length) <= cols) {
          current += ` ${word}`;
        } else {
          pushLine(current);
          current = word;
        }
      }

      if (current && lines.length < rows) pushLine(current);
      return lines.slice(0, rows).join('\n');
    }

    function sanitizeGiftUrl(input) {
      try {
        const u = new URL(String(input || '').trim());
        if (u.protocol !== 'https:') return '';
        return u.href;
      } catch { return ''; }
    }

    function getGiftDomain(url) {
      try { return new URL(url).hostname.replace(/^www\./i, ''); } catch { return ''; }
    }

    function replay() {
      const root = document.getElementById('cardRoot');
      root.classList.remove('play');
      void root.offsetWidth;
      root.classList.add('play');
    }

    function buildFrameDecor(frameDecorType, density = 16, viewerMode = false, targetId = 'frameDecor') {
      const frameDecor = document.getElementById(targetId);
      if (!frameDecor) return;
      const type = normalizeType(frameDecorType);
      frameDecor.innerHTML = '';
      const count = Math.max(10, Math.min(28, Number(density) || 16));
      const minTop = viewerMode ? 64 : 44;
      for (let i = 0; i < count; i += 1) {
        const item = document.createElement('div');
        item.className = `frame-item ${type}`;
        item.style.left = `${Math.round(8 + Math.random() * 84)}%`;
        item.style.top = `${Math.round(minTop + Math.random() * (96 - minTop))}%`;
        item.style.setProperty('--delay', `${(Math.random() * 1.5).toFixed(2)}s`);
        frameDecor.appendChild(item);
      }
    }

    window.setCardData = (data) => {
      document.getElementById('themeStyles').href = data.themeCssHref || '';
      const p = data.palette || {};
      const t = data.timing || {};
      const f = data.features || {};

      setVar('--paper', data.paperOverride || p.paper || '#fff7f2');
      setVar('--ink', data.inkOverride || p.ink || '#2b2622');
      if (p.accent) setVar('--accent', p.accent);
      if (p.accent2) setVar('--accent2', p.accent2);
      if (p.gold) setVar('--gold', p.gold);

      if (t.balloonsMs != null) setVar('--balloons-duration', `${t.balloonsMs}ms`);
      if (t.insideDelayMs != null) setVar('--inside-delay', `${t.insideDelayMs}ms`);
      if (t.headlineDelayMs != null) setVar('--headline-delay', `${t.headlineDelayMs}ms`);
      if (t.subDelayMs != null) setVar('--sub-delay', `${t.subDelayMs}ms`);
      if (t.fromDelayMs != null) setVar('--from-delay', `${t.fromDelayMs}ms`);
      if (t.fxStartMs != null) setVar('--fx-start', `${t.fxStartMs}ms`);

      applyFont(data.fontId || 'fredoka');
      buildFrameDecor(f.decorType || f.frameDecor || f.revealType || 'balloons', f.decorDensity || 16, true, 'frameDecor');
      buildFrameDecor(f.decorType || f.frameDecor || f.revealType || 'balloons', f.decorDensity || 16, false, 'frameDecorPhoto');
      buildFrameDecor(f.decorType || f.frameDecor || f.revealType || 'balloons', f.decorDensity || 16, false, 'frameDecorOverlay');

      document.getElementById('headline').innerHTML = data.headline || '';
      document.getElementById('message').textContent = wrapAndClampMessage(data.message, 19, 12);
      document.getElementById('from').textContent = data.from || '';

      const photoEl = document.getElementById('photo');
      const placeholder = document.getElementById('placeholder');
      if (data.viewer || !data.photoDataUrl) {
        photoEl.style.display = 'none';
        photoEl.removeAttribute('src');
        placeholder.style.display = 'flex';
      } else {
        photoEl.src = data.photoDataUrl;
        photoEl.style.display = 'block';
        placeholder.style.display = 'none';
      }

      const safeGiftUrl = sanitizeGiftUrl(data.giftUrl || '');
      const giftButton = document.getElementById('giftButton');
      const giftDomain = document.getElementById('giftDomain');
      if (safeGiftUrl) {
        giftButton.href = safeGiftUrl;
        giftButton.style.display = 'inline-flex';
        giftDomain.textContent = `Opens: ${getGiftDomain(safeGiftUrl)}`;
        giftDomain.style.display = 'block';
      } else {
        giftButton.style.display = 'none';
        giftDomain.style.display = 'none';
      }

      document.getElementById('watermark').style.display = data.watermark ? 'block' : 'none';
      document.getElementById('balloonCurtain').setAttribute('data-reveal', normalizeType(f.revealType || 'balloons'));
      document.getElementById('confetti').style.display = f.confetti ? 'block' : 'none';
      document.getElementById('sparkles').style.display = f.sparkles ? 'block' : 'none';
      replay();
    };

    window.play = replay;
    replay();
  </script>
</body>
</html>
