<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="./card-base.css" />
  <link id="themeStyles" rel="stylesheet" href="" />
  <title>Card Preview</title>
</head>
<body>
  <div class="card-root" id="cardRoot">
    <div class="balloon-curtain" id="balloonCurtain" data-reveal="balloons">
      <div class="dissolve-layer" id="dissolveLayer"></div>
    </div>

    <div class="card">
      <div class="panel top">
        <div class="headline" id="headline">Happy Day</div>
        <div class="message" id="message"></div>
        <div class="from" id="from"></div>
      </div>

      <div class="panel bottom">
        <div class="photo-wrap">
          <div class="photo-slot" id="photoSlot">
            <img id="photo" alt="Uploaded" style="display:none;" />
            <div class="placeholder" id="placeholder"><span>Upload a photo</span></div>
          </div>
          <div class="frame-decor" id="frameDecor"></div>
        </div>
        <a id="giftButton" class="gift-button" target="_blank" rel="noopener" style="display:none;">View Gift</a>
      </div>
    </div>

    <div class="confetti" id="confetti">
      <span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="sparkles" id="sparkles">
      <span></span><span></span><span></span><span></span>
    </div>

    <div class="watermark" id="watermark">Made with JWorldCreations</div>
  </div>

  <script>
    const ITEM_TYPES = ['balloons', 'hearts', 'stars', 'snow', 'confetti'];

    function normalizeType(type) {
      return ITEM_TYPES.includes(type) ? type : 'balloons';
    }

    function setVar(k, v) {
      document.documentElement.style.setProperty(k, v);
    }

    function replay() {
      const root = document.getElementById('cardRoot');
      if (!root) return;
      root.classList.remove('play');
      void root.offsetWidth;
      root.classList.add('play');
    }

    function buildFrameDecor(frameDecorType) {
      const frameDecor = document.getElementById('frameDecor');
      if (!frameDecor) return;

      const type = normalizeType(frameDecorType);
      frameDecor.innerHTML = '';

      const ringPositions = [
        { left: 0, top: 0 },
        { left: 50, top: 0 },
        { left: 100, top: 0 },
        { left: 0, top: 50 },
        { left: 100, top: 50 },
        { left: 0, top: 100 },
        { left: 50, top: 100 },
        { left: 100, top: 100 }
      ];

      const count = Math.floor(Math.random() * 5) + 10;

      while (ringPositions.length < count) {
        const edge = Math.floor(Math.random() * 4);
        const p = Math.round(Math.random() * 100);
        if (edge === 0) ringPositions.push({ left: p, top: 0 });
        if (edge === 1) ringPositions.push({ left: 100, top: p });
        if (edge === 2) ringPositions.push({ left: p, top: 100 });
        if (edge === 3) ringPositions.push({ left: 0, top: p });
      }

      for (let i = 0; i < count; i += 1) {
        const item = document.createElement('div');
        const pos = ringPositions[i];
        item.className = `frame-item ${type}`;
        item.style.left = `${pos.left}%`;
        item.style.top = `${pos.top}%`;
        item.style.setProperty('--delay', `${(Math.random() * 1.5).toFixed(2)}s`);
        frameDecor.appendChild(item);
      }
    }

    window.setCardData = (data) => {
      const themeStyles = document.getElementById('themeStyles');
      if (themeStyles) {
        themeStyles.href = data.themeCssHref || '';
      }

      const p = data.palette || {};
      const t = data.timing || {};

      if (p.paper) setVar('--paper', p.paper);
      if (p.ink) setVar('--ink', p.ink);
      if (p.accent) setVar('--accent', p.accent);
      if (p.accent2) setVar('--accent2', p.accent2);
      if (p.gold) setVar('--gold', p.gold);

      if (t.balloonsMs != null) setVar('--balloons-duration', `${t.balloonsMs}ms`);
      if (t.insideDelayMs != null) setVar('--inside-delay', `${t.insideDelayMs}ms`);
      if (t.headlineDelayMs != null) setVar('--headline-delay', `${t.headlineDelayMs}ms`);
      if (t.subDelayMs != null) setVar('--sub-delay', `${t.subDelayMs}ms`);
      if (t.fromDelayMs != null) setVar('--from-delay', `${t.fromDelayMs}ms`);
      if (t.fxStartMs != null) setVar('--fx-start', `${t.fxStartMs}ms`);
      if (t.fxStopMs != null) setVar('--fx-stop', `${t.fxStopMs}ms`);

      const f = data.features || {};
      const revealType = normalizeType(f.revealType || 'balloons');
      const frameDecor = (f.frameDecor || revealType);

      if (f.overlayIntensity != null) {
        setVar('--overlay-intensity', f.overlayIntensity);
      }

      buildFrameDecor(frameDecor);

      const headlineEl = document.getElementById('headline');
      const messageEl = document.getElementById('message');
      const fromEl = document.getElementById('from');
      const photoEl = document.getElementById('photo');
      const placeholderEl = document.getElementById('placeholder');

      if (headlineEl) headlineEl.innerHTML = data.headline || '';
      if (messageEl) messageEl.textContent = data.message || '';
      if (fromEl) fromEl.textContent = data.from || '';

      if (photoEl && placeholderEl) {
        if (data.photoDataUrl) {
          photoEl.src = data.photoDataUrl;
          photoEl.style.display = 'block';
          placeholderEl.style.display = 'none';
        } else {
          photoEl.removeAttribute('src');
          photoEl.style.display = 'none';
          placeholderEl.style.display = 'flex';
        }
      }

      const wm = document.getElementById('watermark');
      if (wm) wm.style.display = data.watermark ? 'block' : 'none';

      const giftBtn = document.getElementById('giftButton');
      if (giftBtn) {
        if (data.giftUrl) {
          giftBtn.href = data.giftUrl;
          giftBtn.style.display = 'inline-flex';
        } else {
          giftBtn.style.display = 'none';
          giftBtn.removeAttribute('href');
        }
      }

      const curtain = document.getElementById('balloonCurtain');
      const confetti = document.getElementById('confetti');
      const sparkles = document.getElementById('sparkles');

      const showCurtain = f.balloonCurtain !== false;
      if (curtain) {
        curtain.style.display = showCurtain ? 'block' : 'none';
        curtain.setAttribute('data-reveal', revealType);
      }
      if (confetti) confetti.style.display = f.confetti ? 'block' : 'none';
      if (sparkles) sparkles.style.display = f.sparkles ? 'block' : 'none';

      replay();
    };

    window.play = replay;
    replay();
  </script>
</body>
</html>
