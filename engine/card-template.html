<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="./card-base.css" />
  <link id="themeStyles" rel="stylesheet" href="" />
  <title>Card Preview</title>
</head>
<body>
  <div class="card-root" id="cardRoot">
    <div class="balloon-curtain" id="balloonCurtain">
      <div class="curtain-layer"></div>
    </div>

    <div class="card">
      <div class="panel top">
        <div class="headline" id="headline">Happy Day</div>
        <div class="message" id="message"></div>
        <div class="from" id="from"></div>
      </div>

      <div class="panel bottom">
        <div class="photo-wrap" id="photoWrap">
          <div class="photo-slot" id="photoSlot">
            <img id="photo" alt="Uploaded" style="display:none;" />
            <div class="placeholder" id="placeholder">
              <span>Upload a photo</span>
            </div>
          </div>
          <div class="frame-decor" id="frameDecor" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <div class="confetti" id="confetti">
      <span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="sparkles" id="sparkles">
      <span></span><span></span><span></span><span></span>
    </div>

    <div class="watermark" id="watermark">Made with JWorldCreations</div>
  </div>

  <script>
    const REVEAL_COUNTS = {
      balloons: 12,
      hearts: 16,
      stars: 16,
      snow: 24,
      confetti: 20
    };

    const FRAME_DECOR_POSITIONS = [
      { x: -6, y: -6 },
      { x: 50, y: -8 },
      { x: 106, y: -6 },
      { x: -8, y: 50 },
      { x: 108, y: 50 },
      { x: -6, y: 106 },
      { x: 50, y: 108 },
      { x: 106, y: 106 }
    ];

    function setVar(k, v) {
      document.documentElement.style.setProperty(k, v);
    }

    function replay() {
      const root = document.getElementById('cardRoot');
      if (!root) return;
      root.classList.remove('play');
      void root.offsetWidth;
      root.classList.add('play');
    }

    function buildCurtainItems(type = 'balloons', intensity = 0.75) {
      const curtain = document.getElementById('balloonCurtain');
      if (!curtain) return;
      const layer = curtain.querySelector('.curtain-layer');
      if (!layer) return;

      layer.innerHTML = '';
      const count = Math.max(6, Math.round((REVEAL_COUNTS[type] || REVEAL_COUNTS.balloons) * (0.5 + intensity)));
      const normalized = ['balloons', 'hearts', 'stars', 'snow', 'confetti'].includes(type) ? type : 'balloons';

      curtain.dataset.revealType = normalized;
      setVar('--overlay-intensity', String(Math.max(0, Math.min(1, intensity))));

      for (let i = 0; i < count; i += 1) {
        const item = document.createElement('span');
        item.className = `curtain-item ${normalized}`;
        item.style.setProperty('--i', i + 1);
        item.style.setProperty('--x', `${(i * 37) % 100}%`);
        item.style.setProperty('--drift', `${((i % 5) - 2) * 6}px`);
        item.style.setProperty('--delay', `${(i % 7) * -0.2}s`);
        layer.appendChild(item);
      }
    }

    function buildFrameDecor(type = 'balloons', intensity = 0.65) {
      const frameDecor = document.getElementById('frameDecor');
      if (!frameDecor) return;

      frameDecor.innerHTML = '';
      const normalized = ['balloons', 'hearts', 'stars', 'snow', 'confetti'].includes(type) ? type : 'balloons';
      frameDecor.dataset.decorType = normalized;

      const count = Math.max(4, Math.round(FRAME_DECOR_POSITIONS.length * (0.45 + intensity * 0.55)));
      for (let i = 0; i < count; i += 1) {
        const p = FRAME_DECOR_POSITIONS[i % FRAME_DECOR_POSITIONS.length];
        const item = document.createElement('span');
        item.className = `frame-item ${normalized}`;
        item.style.left = `${p.x}%`;
        item.style.top = `${p.y}%`;
        item.style.setProperty('--delay', `${(i % 4) * -0.35}s`);
        frameDecor.appendChild(item);
      }
    }

    window.setCardData = (data) => {
      const themeStyles = document.getElementById('themeStyles');
      if (themeStyles) {
        themeStyles.href = data.themeCssHref || '';
      }

      const p = data.palette || {};
      const t = data.timing || {};

      if (p.paper) setVar('--paper', p.paper);
      if (p.ink) setVar('--ink', p.ink);
      if (p.accent) setVar('--accent', p.accent);
      if (p.accent2) setVar('--accent2', p.accent2);
      if (p.gold) setVar('--gold', p.gold);

      if (t.balloonsMs != null) setVar('--balloons-duration', `${t.balloonsMs}ms`);
      if (t.insideDelayMs != null) setVar('--inside-delay', `${t.insideDelayMs}ms`);
      if (t.headlineDelayMs != null) setVar('--headline-delay', `${t.headlineDelayMs}ms`);
      if (t.subDelayMs != null) setVar('--sub-delay', `${t.subDelayMs}ms`);
      if (t.fromDelayMs != null) setVar('--from-delay', `${t.fromDelayMs}ms`);
      if (t.fxStartMs != null) setVar('--fx-start', `${t.fxStartMs}ms`);
      if (t.fxStopMs != null) setVar('--fx-stop', `${t.fxStopMs}ms`);

      const f = data.features || {};
      const revealType = f.revealType || (f.balloonCurtain ? 'balloons' : 'balloons');
      const frameDecor = f.frameDecor || revealType;
      const overlayIntensity = typeof f.overlayIntensity === 'number' ? f.overlayIntensity : 0.7;

      buildCurtainItems(revealType, overlayIntensity);
      buildFrameDecor(frameDecor, overlayIntensity);

      const headlineEl = document.getElementById('headline');
      const messageEl = document.getElementById('message');
      const fromEl = document.getElementById('from');
      const photoEl = document.getElementById('photo');
      const placeholderEl = document.getElementById('placeholder');

      if (headlineEl) headlineEl.innerHTML = data.headline || '';
      if (messageEl) messageEl.textContent = data.message || '';
      if (fromEl) fromEl.textContent = data.from || '';

      if (photoEl && placeholderEl) {
        if (data.photoDataUrl) {
          photoEl.src = data.photoDataUrl;
          photoEl.style.display = 'block';
          placeholderEl.style.display = 'none';
        } else {
          photoEl.removeAttribute('src');
          photoEl.style.display = 'none';
          placeholderEl.style.display = 'flex';
        }
      }

      const wm = document.getElementById('watermark');
      if (wm) wm.style.display = data.watermark ? 'block' : 'none';

      const curtain = document.getElementById('balloonCurtain');
      const confetti = document.getElementById('confetti');
      const sparkles = document.getElementById('sparkles');

      const showCurtain = f.balloonCurtain !== false;
      if (curtain) curtain.style.display = showCurtain ? 'flex' : 'none';
      if (confetti) confetti.style.display = f.confetti ? 'block' : 'none';
      if (sparkles) sparkles.style.display = f.sparkles ? 'block' : 'none';

      replay();
    };

    window.play = replay;
    replay();
  </script>
</body>
</html>
