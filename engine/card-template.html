<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="./card-base.css" />
  <link id="themeStyles" rel="stylesheet" href="" />
  <title>Card Preview</title>
</head>
<body>
  <div class="card-root" id="cardRoot">
    <div class="balloon-curtain" id="balloonCurtain" data-reveal="balloons">
      <div class="dissolve-layer" id="dissolveLayer"></div>
    </div>

    <div class="card">
      <div class="panel top">
        <div class="headline" id="headline">Happy Day</div>
        <div class="message" id="message"></div>
        <div class="from" id="from"></div>
      </div>

      <div class="panel bottom">
        <div class="photo-wrap" id="photoWrap">
          <div class="photo-slot" id="photoSlot">
            <img id="photo" alt="Uploaded" style="display:none;" />
            <div class="placeholder" id="placeholder"><span>Upload a photo</span></div>
          </div>
          <div class="frame-decor frame-decor-photo" id="frameDecorPhoto"></div>
        </div>
        <div class="decor-panel" id="decorPanel">
          <div class="frame-decor" id="frameDecor"></div>
        </div>
        <a id="giftButton" class="gift-button" target="_blank" rel="noopener noreferrer" style="display:none;">View Gift</a>
        <div id="giftDomain" class="gift-domain" style="display:none;"></div>
      </div>
    </div>

    <div class="confetti" id="confetti">
      <span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="sparkles" id="sparkles">
      <span></span><span></span><span></span><span></span>
    </div>

    <div class="watermark" id="watermark">Made with JWorldCreations</div>
  </div>

  <script>
    const ITEM_TYPES = ['balloons', 'hearts', 'stars', 'snow', 'confetti'];

    function sanitizeGiftUrl(input) {
      if (typeof input !== 'string') return '';
      const trimmed = input.trim();
      if (!trimmed || trimmed.length > 500) return '';

      let url;
      try {
        url = new URL(trimmed);
      } catch {
        return '';
      }

      if (url.protocol !== 'https:') return '';
      if (url.username || url.password) return '';

      const href = url.href;
      return href.length <= 500 ? href : '';
    }

    function getGiftDomain(url) {
      try {
        const hostname = new URL(url).hostname || '';
        return hostname.replace(/^www\./i, '');
      } catch {
        return '';
      }
    }

    function normalizeType(type) {
      return ITEM_TYPES.includes(type) ? type : 'balloons';
    }

    function setVar(k, v) {
      document.documentElement.style.setProperty(k, v);
    }

    function replay() {
      const root = document.getElementById('cardRoot');
      if (!root) return;
      root.classList.remove('play');
      void root.offsetWidth;
      root.classList.add('play');
    }

    function buildFrameDecor(frameDecorType, density = 16, viewerMode = false, targetId = 'frameDecor') {
      const frameDecor = document.getElementById(targetId);
      if (!frameDecor) return;

      const type = normalizeType(frameDecorType);
      frameDecor.innerHTML = '';

      const count = Math.max(10, Math.min(28, Number(density) || 16));
      const positions = [];

      // border-safe items
      const edgeCount = Math.floor(count * 0.45);
      for (let i = 0; i < edgeCount; i += 1) {
        const edge = Math.floor(Math.random() * 4);
        const p = Math.round(Math.random() * 100);
        if (edge === 0) positions.push({ left: p, top: 2 });
        if (edge === 1) positions.push({ left: 98, top: p });
        if (edge === 2) positions.push({ left: p, top: 98 });
        if (edge === 3) positions.push({ left: 2, top: p });
      }

      // decor-panel-safe items (bottom only in viewer mode)
      const minTop = viewerMode ? 64 : 44;
      while (positions.length < count) {
        positions.push({
          left: Math.round(8 + Math.random() * 84),
          top: Math.round(minTop + Math.random() * (96 - minTop))
        });
      }

      for (let i = 0; i < count; i += 1) {
        const item = document.createElement('div');
        const pos = positions[i];
        item.className = `frame-item ${type}`;
        item.style.left = `${pos.left}%`;
        item.style.top = `${pos.top}%`;
        item.style.setProperty('--delay', `${(Math.random() * 1.5).toFixed(2)}s`);
        frameDecor.appendChild(item);
      }
    }

    window.setCardData = (data) => {
      const themeStyles = document.getElementById('themeStyles');
      if (themeStyles) {
        themeStyles.href = data.themeCssHref || '';
      }

      const p = data.palette || {};
      const t = data.timing || {};

      if (p.paper) setVar('--paper', p.paper);
      if (p.ink) setVar('--ink', p.ink);
      if (p.accent) setVar('--accent', p.accent);
      if (p.accent2) setVar('--accent2', p.accent2);
      if (p.gold) setVar('--gold', p.gold);

      if (t.balloonsMs != null) setVar('--balloons-duration', `${t.balloonsMs}ms`);
      if (t.insideDelayMs != null) setVar('--inside-delay', `${t.insideDelayMs}ms`);
      if (t.headlineDelayMs != null) setVar('--headline-delay', `${t.headlineDelayMs}ms`);
      if (t.subDelayMs != null) setVar('--sub-delay', `${t.subDelayMs}ms`);
      if (t.fromDelayMs != null) setVar('--from-delay', `${t.fromDelayMs}ms`);
      if (t.fxStartMs != null) setVar('--fx-start', `${t.fxStartMs}ms`);
      if (t.fxStopMs != null) setVar('--fx-stop', `${t.fxStopMs}ms`);

      const f = data.features || {};
      const revealType = normalizeType(f.revealType || 'balloons');
      const decorType = normalizeType(f.decorType || f.frameDecor || revealType);
      const decorDensity = Math.max(10, Math.min(28, Number(f.decorDensity) || 16));
      const viewerMode = data.viewer === true || data.mode === 'viewer';

      if (f.overlayIntensity != null) {
        setVar('--overlay-intensity', f.overlayIntensity);
      }

      buildFrameDecor(decorType, decorDensity, viewerMode, viewerMode ? 'frameDecor' : 'frameDecorPhoto');

      const headlineEl = document.getElementById('headline');
      const messageEl = document.getElementById('message');
      const fromEl = document.getElementById('from');
      if (headlineEl) headlineEl.innerHTML = data.headline || '';
      if (messageEl) messageEl.textContent = data.message || '';
      if (fromEl) fromEl.textContent = data.from || '';

      const root = document.getElementById('cardRoot');
      if (root) root.dataset.mode = viewerMode ? 'viewer' : 'editor';

      const photoWrap = document.getElementById('photoWrap');
      const decorPanel = document.getElementById('decorPanel');
      if (photoWrap) photoWrap.style.display = viewerMode ? 'none' : 'block';
      if (decorPanel) decorPanel.style.display = viewerMode ? 'block' : 'none';

      const photoEl = document.getElementById('photo');
      const placeholderEl = document.getElementById('placeholder');
      if (!viewerMode && photoEl && placeholderEl) {
        if (data.photoDataUrl) {
          photoEl.src = data.photoDataUrl;
          photoEl.style.display = 'block';
          placeholderEl.style.display = 'none';
        } else {
          photoEl.removeAttribute('src');
          photoEl.style.display = 'none';
          placeholderEl.style.display = 'flex';
        }
      }

      const wm = document.getElementById('watermark');
      if (wm) wm.style.display = data.watermark ? 'block' : 'none';

      const giftBtn = document.getElementById('giftButton');
      const giftDomain = document.getElementById('giftDomain');
      const safeGiftUrl = sanitizeGiftUrl(data.giftUrl || '');
      if (giftBtn && giftDomain) {
        if (safeGiftUrl) {
          giftBtn.href = safeGiftUrl;
          giftBtn.style.display = 'inline-flex';
          giftDomain.textContent = `Opens: ${getGiftDomain(safeGiftUrl)}`;
          giftDomain.style.display = 'block';
        } else {
          giftBtn.style.display = 'none';
          giftBtn.removeAttribute('href');
          giftDomain.style.display = 'none';
          giftDomain.textContent = '';
        }
      }

      const curtain = document.getElementById('balloonCurtain');
      const confetti = document.getElementById('confetti');
      const sparkles = document.getElementById('sparkles');

      const showCurtain = f.balloonCurtain !== false;
      if (curtain) {
        curtain.style.display = showCurtain ? 'block' : 'none';
        curtain.setAttribute('data-reveal', revealType);
      }
      if (confetti) confetti.style.display = f.confetti ? 'block' : 'none';
      if (sparkles) sparkles.style.display = f.sparkles ? 'block' : 'none';

      replay();
    };


    window.getCardRect = () => {
      const root = document.getElementById('cardRoot');
      if (!root) return null;
      const rect = root.getBoundingClientRect();
      return {
        left: rect.left,
        top: rect.top,
        width: rect.width,
        height: rect.height
      };
    };

    window.play = replay;
    replay();
  </script>
</body>
</html>
